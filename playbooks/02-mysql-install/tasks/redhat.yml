---

- name: Enable CodeReady Builder repository
  command: >
    dnf config-manager --set-enabled
    {{ 'crb' if ansible_distribution in ['Rocky', 'AlmaLinux'] else 'codeready-builder-for-rhel-' + ansible_distribution_major_version + '-x86_64-rpms' }}
  changed_when: false

- name: Install MySQL packages (RedHat)
  package:
    name:
      - mysql-server
      - mysql
      - python3-PyMySQL
      - mysql-devel
    state: present

- name: Determine mysql-shell RPM URL based on EL version
  set_fact:
    mysql_shell_rpm: "https://repo.mysql.com/yum/mysql-tools-community/el/{{ ansible_distribution_major_version }}/x86_64/mysql-shell-8.0.44-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"

- name: Install mysql-shell from MySQL repository
  yum:
    name: "{{ mysql_shell_rpm }}"
    state: present
    disable_gpg_check: yes

# ─── Post-Install Verification ─────────────────────────────

- name: List installed MySQL packages
  shell: rpm -qa | grep -i mysql
  register: mysql_packages_installed
  changed_when: false

- name: Display installed MySQL packages
  debug:
    var: mysql_packages_installed.stdout_lines

- name: Install yum-plugin-versionlock
  package:
    name: "{{ 'yum-plugin-versionlock' if ansible_distribution_major_version | int <= 7 else 'python3-dnf-plugin-versionlock' }}"
    state: present

- name: Hold MySQL server package version
  community.general.yum_versionlock:
    name: mysql-server
    state: present

- name: Verify held packages
  shell: "{{ 'yum versionlock list' if ansible_distribution_major_version | int <= 7 else 'dnf versionlock list' }}"
  register: held_packages
  changed_when: false

- name: Display held packages
  debug:
    var: held_packages.stdout_lines


- name: Ensure mysqld systemd override directory exists
  file:
    path: /etc/systemd/system/mysqld.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy mysqld systemd resource limits drop-in
  copy:
    dest: /etc/systemd/system/mysqld.service.d/limits.conf
    content: |
      [Service]
      LimitNOFILE=65535
      LimitNPROC=65535
      LimitMEMLOCK=infinity
      ExecStart=
      ExecStart=/usr/bin/numactl --interleave=all /usr/libexec/mysqld
    owner: root
    group: root
    mode: '0644'
  notify: systemd daemon-reload


