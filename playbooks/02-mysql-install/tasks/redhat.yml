---

- name: Determine CRB repository name
  set_fact:
    crb_repo_name: "{{ 'crb' if ansible_distribution in ['Rocky', 'AlmaLinux'] else 'codeready-builder-for-rhel-' + ansible_distribution_major_version + '-x86_64-rpms' }}"

- name: Check if CRB repository is already enabled
  shell: dnf repolist enabled 2>/dev/null | grep -q "^{{ crb_repo_name }}"
  register: crb_status
  changed_when: false
  failed_when: false

- name: Enable CodeReady Builder repository
  command: dnf config-manager --set-enabled {{ crb_repo_name }}
  when: crb_status.rc != 0


- name: Install MySQL packages (RedHat)
  package:
    name:
      - mysql-server
      - mysql
      - python3-PyMySQL
      - mysql-devel
      - numactl
    state: present

- name: Determine mysql-shell RPM URL based on EL version
  set_fact:
    mysql_shell_rpm: "https://repo.mysql.com/yum/mysql-tools-community/el/{{ ansible_distribution_major_version }}/x86_64/mysql-shell-8.0.44-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"

- name: Install mysql-shell from MySQL repository
  yum:
    name: "{{ mysql_shell_rpm }}"
    state: present
    disable_gpg_check: yes


- name: List installed MySQL packages
  shell: rpm -qa | grep -i mysql
  register: mysql_packages_installed
  changed_when: false

- name: Display installed MySQL packages
  debug:
    var: mysql_packages_installed.stdout_lines


- name: Install yum-plugin-versionlock
  package:
    name: "{{ 'yum-plugin-versionlock' if ansible_distribution_major_version | int <= 7 else 'python3-dnf-plugin-versionlock' }}"
    state: present

- name: Hold MySQL server package version
  community.general.yum_versionlock:
    name: mysql-server
    state: present

- name: Verify held packages
  shell: "{{ 'yum versionlock list' if ansible_distribution_major_version | int <= 7 else 'dnf versionlock list' }}"
  register: held_packages
  changed_when: false

- name: Display held packages
  debug:
    var: held_packages.stdout_lines

- name: Ensure mysqld systemd override directory exists
  file:
    path: /etc/systemd/system/mysqld.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy mysqld systemd resource limits drop-in
  copy:
    dest: /etc/systemd/system/mysqld.service.d/limits.conf
    content: |
      [Service]
      LimitNOFILE=65535
      LimitNPROC=65535
      LimitMEMLOCK=infinity
      ExecStart=
      ExecStart=/usr/bin/numactl --interleave=all /usr/libexec/mysqld
    owner: root
    group: root
    mode: '0644'
  notify: systemd daemon-reload

- name: Flush handlers
  meta: flush_handlers


- name: Ensure MySQL service is started and enabled
  systemd:
    name: "{{ mysql_service_name }}"
    state: started
    enabled: yes

- name: Check MySQL service status
  command: "systemctl status {{ mysql_service_name }}"
  register: mysql_service_status
  changed_when: false

- name: Display MySQL service status
  debug:
    var: mysql_service_status.stdout_lines


- name: Check if MySQL root can connect without password (socket/empty auth)
  command: mysql -u root -e "SELECT 1"
  register: mysql_root_nopass
  changed_when: false
  ignore_errors: true
  no_log: true

- name: Set root user password (first run - socket auth)
  command: >
    mysql -u root -e
    "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '{{ mysql_root_password }}'; FLUSH PRIVILEGES;"
  when: mysql_root_nopass.rc == 0
  no_log: true

- name: Set root user password (subsequent run - existing password)
  community.mysql.mysql_user:
    name: root
    password: "{{ mysql_root_password }}"
    login_unix_socket: "{{ mysql_socket_path }}"
    host: localhost
    login_user: root
    login_password: "{{ mysql_root_password }}"
    state: present
    update_password: always
  when: mysql_root_nopass.rc != 0
  no_log: true
