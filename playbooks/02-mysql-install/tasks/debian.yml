---

- name: Download mysql-apt-config package from MySQL repo
  get_url:
    url: https://repo.mysql.com/mysql-apt-config_0.8.36-1_all.deb
    dest: /tmp/mysql-apt-config_0.8.36-1_all.deb
    mode: '0644'

- name: Install mysql-apt-config package
  apt:
    deb: /tmp/mysql-apt-config_0.8.36-1_all.deb
    state: present

- name: Update apt cache
  apt:
    update_cache: yes

- name: Install MySQL packages (Debian)
  package:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    - mysql-server
    - mysql-client
    - mysql-shell
    - python3-mysqldb
    - libmysqlclient-dev


- name: List installed MySQL packages
  shell: apt list --installed 2>/dev/null | grep mysql
  register: mysql_packages_installed
  changed_when: false

- name: Display installed MySQL packages
  debug:
    var: mysql_packages_installed.stdout_lines

- name: Hold MySQL server package version
  dpkg_selections:
    name: mysql-server
    selection: hold

- name: Verify held packages
  shell: apt-mark showhold
  register: held_packages
  changed_when: false

- name: Display held packages
  debug:
    var: held_packages.stdout_lines

- name: Ensure mysql systemd override directory exists
  file:
    path: /etc/systemd/system/mysql.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy mysql systemd resource limits drop-in
  copy:
    dest: /etc/systemd/system/mysql.service.d/limits.conf
    content: |
      [Service]
      LimitNOFILE=65535
      LimitNPROC=65535
      LimitMEMLOCK=infinity
      ExecStart=
      ExecStart=/usr/bin/numactl --interleave=all /usr/sbin/mysqld
    owner: root
    group: root
    mode: '0644'
  notify: systemd daemon-reload


