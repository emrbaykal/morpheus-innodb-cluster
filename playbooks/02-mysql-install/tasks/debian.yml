---

- name: Download mysql-apt-config package from MySQL repo
  get_url:
    url: https://repo.mysql.com/mysql-apt-config_0.8.36-1_all.deb
    dest: /tmp/mysql-apt-config_0.8.36-1_all.deb
    mode: '0644'

- name: Install mysql-apt-config package
  apt:
    deb: /tmp/mysql-apt-config_0.8.36-1_all.deb
    state: present

- name: Update apt cache
  apt:
    update_cache: yes

- name: Install MySQL packages (Debian)
  apt:
    name:
      - mysql-server
      - mysql-client
      - mysql-shell
      - python3-mysqldb
      - libmysqlclient-dev
      - numactl
    state: present

- name: List installed MySQL packages
  shell: apt list --installed 2>/dev/null | grep mysql
  register: mysql_packages_installed
  changed_when: false

- name: Display installed MySQL packages
  debug:
    var: mysql_packages_installed.stdout_lines


- name: Hold MySQL server package version
  dpkg_selections:
    name: mysql-server
    selection: hold

- name: Verify held packages
  shell: apt-mark showhold
  register: held_packages
  changed_when: false

- name: Display held packages
  debug:
    var: held_packages.stdout_lines

- name: Ensure mysql systemd override directory exists
  file:
    path: /etc/systemd/system/mysql.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy mysql systemd resource limits drop-in
  copy:
    dest: /etc/systemd/system/mysql.service.d/limits.conf
    content: |
      [Service]
      LimitNOFILE=65535
      LimitNPROC=65535
      LimitMEMLOCK=infinity
      ExecStart=
      ExecStart=/usr/bin/numactl --interleave=all /usr/sbin/mysqld
    owner: root
    group: root
    mode: '0644'
  notify: systemd daemon-reload

- name: Flush handlers
  meta: flush_handlers


- name: Ensure MySQL service is started and enabled
  systemd:
    name: "{{ mysql_service_name }}"
    state: started
    enabled: yes

- name: Check MySQL service status
  command: "systemctl status {{ mysql_service_name }}"
  register: mysql_service_status
  changed_when: false

- name: Display MySQL service status
  debug:
    var: mysql_service_status.stdout_lines


- name: Set root user password (first run - empty password)
  community.mysql.mysql_user:
    name: root
    password: "{{ mysql_root_password }}"
    login_unix_socket: "{{ mysql_socket_path }}"
    host: localhost
    login_user: root
    login_password: ''
    state: present
  register: root_pw_first
  ignore_errors: true
  no_log: true

- name: Set root user password (subsequent run - existing password)
  community.mysql.mysql_user:
    name: root
    password: "{{ mysql_root_password }}"
    login_unix_socket: "{{ mysql_socket_path }}"
    host: localhost
    login_user: root
    login_password: "{{ mysql_root_password }}"
    state: present
  when: root_pw_first is failed
  no_log: true
