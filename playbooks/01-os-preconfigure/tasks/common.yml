---
- name: Deploy issue.net file to the systems
  copy:
    src: issue.net
    dest: /etc/issue.net
    owner: root
    group: root
    mode: '0644'
    backup: yes
  notify: restart_ssh_client

- name: Force all notified SSH services
  meta: flush_handlers

- name: Deploy MySQL system limits to limits.d
  copy:
    dest: /etc/security/limits.d/99-mysql.conf
    content: |
      mysql soft nofile  65535
      mysql hard nofile  65535
      mysql soft nproc   65535
      mysql hard nproc   65535
      mysql soft memlock unlimited
      mysql hard memlock unlimited
    owner: root
    group: root
    mode: '0644'


# ── Transparent Huge Pages (anlık devre dışı) ──────────────

- name: Disable Transparent Huge Pages - enabled (anlık)
  shell: echo never > /sys/kernel/mm/transparent_hugepage/enabled
  changed_when: false

- name: Disable Transparent Huge Pages - defrag (anlık)
  shell: echo never > /sys/kernel/mm/transparent_hugepage/defrag
  changed_when: false

# ── Kernel Parameters (sysctl) ─────────────────────────────

- name: Apply kernel parameters via sysctl
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-01-os-preconfigure.conf
    reload: yes
  loop: "{{ sysctl_params }}"
  loop_control:
    label: "{{ item.name }}"
